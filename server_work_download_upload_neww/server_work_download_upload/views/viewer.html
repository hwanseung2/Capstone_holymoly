<!DOCTYPE html>
<html>
<head runat="server">
    <meta charset="UTF-8">
    <title>viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <link href="css/viewer.css" rel="stylesheet" type="text/css"/>
    <style>
        #btn1{
            margin: 10px;
        }
        #btn{
            margin: 10px;
        }
        #btnSubmit{
            margin: 10px;
        }
    </style>
</head>
<body>


<h1 class="blind">Image Viewer</h1>



<div class="btn-group">
    <button type="button" id="btn1" onclick="window.close()">âŒClose</button>
    <div class="js-download">
        <canvas id="canvas" style="display:none"></canvas>
       <!-- <input type="button" value = "Download" id = "btn" onclick = "getfiledown()" /> -->
        <input type="button" id="btnSubmit" value="ğŸ“‚ë‹¤ìš´ë¡œë“œ"/>
        <button type="submit" onclick="Annotation()">ğŸ–Annotation Mode</button>
        <input type="button" value = "ğŸ–¥predict" id = "btn" onclick = "getAI()"/>
    </div>
</div>

<ul class="ajax-results"></ul>
</body>


<script src="js/Viewer.js"></script>
<script src="js/download.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/easyannotation"></script>

<script>
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");

    function showPer(per) {
        ctx.clearRect(0, 0, 400, 400);
        //ë°”ê¹¥ìª½ ì¨í´ ê·¸ë¦¬ê¸°
        ctx.strokeStyle = "#f66";
        ctx.lineWidth=10;
        ctx.beginPath();
        ctx.arc(60, 60, 50, 0, Math.PI * 2 * per / 100);
        ctx.stroke();
        //ìˆ«ì ì˜¬ë¦¬ê¸°
        ctx.font = '32px serif';
        ctx.fillStyle = "#000";
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(per + '%', 60, 60);
    }
     var name = getUrlValue();
     var url = '/img/' + name;
    $("#btnSubmit").on("click", function(e) {
        $.ajax({
            url: url,
            type : 'get',
            xhrFields: { //response ë°ì´í„°ë¥¼ ë°”ì´ë„ˆë¦¬ë¡œ ì²˜ë¦¬í•œë‹¤.
                responseType: 'blob'
            },
            beforeSend : function() { //ajax í˜¸ì¶œì „ progress ì´ˆê¸°í™”
                showPer(0);
                canvas.style.display = 'block';
            },
            xhr: function() { //XMLHttpRequest ì¬ì •ì˜ ê°€ëŠ¥
                var xhr = $.ajaxSettings.xhr();
                xhr.onprogress = function(e) {
                    showPer(Math.floor(e.loaded / e.total * 100));
                };
                return xhr;
            },
            success : function(data) {
                console.log("ì™„ë£Œ");
                var blob = new Blob([data]);
//íŒŒì¼ì €ì¥
                if (navigator.msSaveBlob) {
                    return navigator.msSaveBlob(blob, url);
                }
                else {
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = url;
                    link.click();
                }
            },
            complete : function() {
                canvas.style.display = 'none';
            }
        });
    });

    function getfiledown(){
        var name = getUrlValue();
        console.log('getfiledown' + name);
        window.location = '/download/' + name;
    }
    function getAI(){
     var name = getUrlValue();
     window.location = '/AI/' + name;

    }
    function getUrlValue(key) {
        //console.log(key);
        var valueObject = {}, hash, value;
        var hashes = window.location.href.slice(window.location.href.indexOf('?'));
        console.log(hashes);
        hash = hashes.split('=');
        //console.log(hash);
        valueObject[hash] = hash[1];
        //console.log(valueObject[hash]);
        num = valueObject[hash];
        if (key) {

            if (valueObject[key]) {
                return valueObject[key];
            }

            return "";
        }
        console.log(valueObject);
        return valueObject[hash];
    }
    function Annotation(){
        var move = confirm('Annotation Mode ë¡œ ì´ë™ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if(move){
            var file_name = getUrlValue();
            console.log(file_name);
            window.location = "annotation.html?name="+ file_name;
        }
        else{
            return;
        }
    }
    //ì´ì¯¤ì—ì„œ scriptë¥¼ ì¶”ê°€í•´ì•¼ í• ë“¯



</script>
</html>
